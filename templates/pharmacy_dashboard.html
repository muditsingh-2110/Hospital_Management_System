<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pharmacy Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <div class="dashboard-container container mt-4 p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="mb-0">Pharmacy Dashboard</h2>
      <div>
        <button type="button" class="btn btn-info me-2" data-bs-toggle="modal" data-bs-target="#stockModal">Show Stock</button>
        <button type="button" class="btn btn-warning me-2" data-bs-toggle="modal" data-bs-target="#updateStockModal">Update Stock</button>
        <a href="{{ url_for('logout') }}" class="btn btn-danger">Logout</a>
      </div>
    </div>

    {% if prescriptions|length == 0 %}
      <div class="alert alert-info text-center">No prescriptions to dispense.</div>
    {% endif %}

    <div class="row">
      {% for p in prescriptions %}
      <div class="col-md-6 mb-4">
        <div class="card" id="row-{{ p.uhid }}">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>UHID: <span class="fw-bold">{{ p.uhid }}</span></span>
            <form method="post" action="{{ url_for('dispense_prescription') }}" class="dispense-form mb-0">
              <input type="hidden" name="uhid" value="{{ p.uhid }}">
              <button type="submit" class="btn btn-success btn-sm">Dispense</button>
            </form>
          </div>
          <div class="card-body">
            {% if p.prescription_list and p.prescription_list|length > 0 %}
            <table class="table table-sm table-bordered mb-0">
              <thead class="table-light">
                <tr><th>Medicine</th><th>Quantity</th></tr>
              </thead>
              <tbody>
              {% for med in p.prescription_list %}
                <tr><td>{{ med.medicine }}</td><td>{{ med.qty }}</td></tr>
              {% endfor %}
              </tbody>
            </table>
            {% else %}
              <em>No prescription details found.</em>
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <div class="modal fade" id="updateStockModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Update Medicine Stock</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <form id="addMedicineForm" class="row g-2 mb-3">
            <div class="col-md-5"><input type="text" class="form-control" id="newMedName" placeholder="New medicine name" required></div>
            <div class="col-md-4"><input type="number" class="form-control" id="newMedStock" placeholder="Initial stock" min="0" required></div>
            <div class="col-md-3"><button type="submit" class="btn btn-success w-100">Add Medicine</button></div>
          </form>
          <input type="text" id="updateStockSearch" class="form-control mb-3" placeholder="Search to filter medicine...">
          <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
            <table class="table table-bordered table-hover" id="updateStockTable">
              <thead class="table-light"><tr><th>Medicine Name</th><th>Current Stock</th><th>New Stock</th><th>Action</th></tr></thead>
              <tbody>
                {% for med in medicines %}
                <tr data-medname="{{ med.name|lower }}">
                  <td>{{ med.name }}</td><td class="current-stock">{{ med.stock }}</td>
                  <td><input type="number" class="form-control form-control-sm new-stock-input" min="0" value="{{ med.stock }}"></td>
                  <td><button type="button" class="btn btn-primary btn-sm update-stock-btn">Update</button></td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="stockModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Medicine Stock</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <input type="text" id="stockSearch" class="form-control mb-3" placeholder="Search to filter medicine...">
          <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
            <table class="table table-bordered table-hover" id="stockTable">
              <thead class="table-light"><tr><th>Medicine Name</th><th>Stock</th></tr></thead>
              <tbody>
                {% for med in medicines %}
                <tr><td>{{ med.name }}</td><td>{{ med.stock }}</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Helper function for API calls with SweetAlert feedback
    async function fetchWithAlert(url, options, successMessage) {
        Swal.fire({
            title: 'Processing...',
            text: 'Please wait.',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });
        try {
            const response = await fetch(url, options);
            const data = await response.json();
            if (data.success) {
                Swal.fire('Success!', successMessage, 'success');
                return data;
            } else {
                throw new Error(data.error || 'An unknown error occurred.');
            }
        } catch (error) {
            Swal.fire('Error!', error.message, 'error');
            return null;
        }
    }

    // Dispense Prescription
    document.querySelectorAll('.dispense-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            Swal.fire({
                title: 'Are you sure?', text: "This will dispense the medicine and update stock.", icon: 'warning',
                showCancelButton: true, confirmButtonColor: '#28A745', cancelButtonColor: '#DC3545', confirmButtonText: 'Yes, dispense it!'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const success = await fetchWithAlert(form.action, { method: 'POST', body: new FormData(form) }, 'Prescription has been dispensed.');
                    if (success) setTimeout(() => location.reload(), 1500);
                }
            });
        });
    });

    // Update Stock
    document.querySelector('#updateStockTable').addEventListener('click', async function(e) {
        if (e.target.classList.contains('update-stock-btn')) {
            const row = e.target.closest('tr');
            const medName = row.children[0].textContent;
            const newStock = row.querySelector('.new-stock-input').value;
            const data = { name: medName, stock: newStock };

            const result = await fetchWithAlert('/update_stock', {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data)
            }, `Stock for ${medName} has been updated.`);
            
            if (result) {
                row.querySelector('.current-stock').textContent = newStock;
            }
        }
    });

    // Add New Medicine
    document.getElementById('addMedicineForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const nameInput = document.getElementById('newMedName');
        const stockInput = document.getElementById('newMedStock');
        const data = { name: nameInput.value.trim(), stock: stockInput.value };

        const result = await fetchWithAlert('/add_medicine', {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data)
        }, `Medicine ${data.name} has been added.`);

        if (result) {
            // No page reload needed, just add to table dynamically
            const tbody = document.querySelector('#updateStockTable tbody');
            const newRow = `
                <tr data-medname="${data.name.toLowerCase()}">
                    <td>${data.name}</td><td class="current-stock">${data.stock}</td>
                    <td><input type="number" class="form-control form-control-sm new-stock-input" min="0" value="${data.stock}"></td>
                    <td><button type="button" class="btn btn-primary btn-sm update-stock-btn">Update</button></td>
                </tr>`;
            tbody.insertAdjacentHTML('beforeend', newRow);
            nameInput.value = '';
            stockInput.value = '';
        }
    });

    // Search/Filter Logic
    document.getElementById('stockSearch')?.addEventListener('keyup', function() {
        const filter = this.value.toLowerCase();
        document.querySelectorAll('#stockTable tbody tr').forEach(row => {
            row.style.display = row.children[0].textContent.toLowerCase().includes(filter) ? '' : 'none';
        });
    });
    document.getElementById('updateStockSearch')?.addEventListener('keyup', function() {
        const filter = this.value.toLowerCase();
        document.querySelectorAll('#updateStockTable tbody tr').forEach(row => {
            row.style.display = row.dataset.medname.includes(filter) ? '' : 'none';
        });
    });
</script>
</body>
</html>