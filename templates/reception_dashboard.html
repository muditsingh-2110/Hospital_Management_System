<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Reception Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body class="p-4">
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="mb-0">Reception Dashboard</h2>
      <div>
        <a href="/register" class="btn btn-success">Register New Patient</a>
        <a href="/logout" class="btn btn-danger">Logout</a>
      </div>
    </div>

    <div class="card p-4 mb-4">
        <h4>Registered Employees</h4>
        {% if employee_data %}
            <div class="table-responsive">
                <table class="table table-bordered table-striped table-hover">
                    <thead><tr><th>UHID</th><th>Emp ID</th><th>Symptoms</th><th>Queue No</th><th>Doctor Assigned</th></tr></thead>
                    <tbody>
                    {% for emp in employee_data %}
                        <tr><td>{{ emp.uhid }}</td><td>{{ emp.emp_id }}</td><td>{{ emp.symptoms }}</td><td>{{ emp.queue_no }}</td><td>{{ emp.doctor_assigned }}</td></tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p>No employee patients registered yet.</p>
        {% endif %}
    </div>

    <div class="card p-4">
        <h4>Registered Non-Employees</h4>
        {% if nonemployee_data %}
            <div class="table-responsive">
                <table class="table table-bordered table-striped table-hover">
                    <thead><tr><th>UHID</th><th>Name</th><th>Age</th><th>Gender</th><th>Symptoms</th><th>Queue No</th><th>Doctor Assigned</th><th>Bill (₹)</th><th>Action</th></tr></thead>
                    <tbody>
                    {% for nonemp in nonemployee_data %}
                        <tr>
                            <td>{{ nonemp.uhid }}</td><td>{{ nonemp.name }}</td><td>{{ nonemp.age }}</td><td>{{ nonemp.gender }}</td>
                            <td>{{ nonemp.symptoms }}</td><td>{{ nonemp.queue_no }}</td><td>{{ nonemp.doctor_assigned }}</td>
                            <td class="bill-cell" id="bill-{{ nonemp.uhid }}">{{ nonemp.bill or 0 }}</td>
                            <td>
                                <button class="btn btn-primary btn-sm billing-btn" data-uhid="{{ nonemp.uhid }}" data-bs-toggle="modal" data-bs-target="#billingModal">Manage Bill</button>
                                <div class="input-group mt-1">
                                  <select class="form-select form-select-sm pay-method-select" data-uhid="{{ nonemp.uhid }}">
                                    <option value="Cash">Cash</option><option value="Online">Online</option>
                                  </select>
                                  <button class="btn btn-success btn-sm clear-bill-btn" data-uhid="{{ nonemp.uhid }}">Clear</button>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p>No non-employee patients registered yet.</p>
        {% endif %}
    </div>
</div>

<div class="modal fade" id="billingModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Manage Bill</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <input type="hidden" id="billingUhid">
        <div class="card p-3 mb-3"><form id="addItemForm" class="row g-2 align-items-center">
            <div class="col-6"><select class="form-select" id="itemSelect" required></select></div>
            <div class="col-3"><input type="number" class="form-control" id="itemQty" min="1" value="1" required placeholder="Qty"></div>
            <div class="col-3"><button type="submit" class="btn btn-success w-100">Add Item</button></div>
        </form></div>
        <div class="table-responsive mb-2"><table class="table table-bordered table-sm" id="billItemsTable">
            <thead><tr><th>Item</th><th>Price</th><th>Qty</th><th>Total</th><th>Remove</th></tr></thead><tbody></tbody>
        </table></div>
        <div class="mb-2 text-end"><strong>Total To Add: ₹<span id="billTotal">0.00</span></strong></div>
        <button id="saveBillBtn" class="btn btn-primary w-100 mb-3">Save Added Items to Bill</button>
        <hr><h6>Billing History</h6>
        <div class="table-responsive" style="max-height: 200px; overflow-y: auto;"><table class="table table-bordered table-sm" id="billHistoryTable">
            <thead><tr><th>Date</th><th>Item</th><th>Price</th><th>Qty</th><th>Total</th></tr></thead><tbody></tbody>
        </table></div>
      </div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let billingItems = []; let billingItemsMap = {}; let billItems = []; let currentUhid = null;

    function loadBillingItems() {
        fetch('/billing_items').then(res => res.json()).then(items => {
            billingItems = items; billingItemsMap = {};
            const select = document.getElementById('itemSelect');
            select.innerHTML = '<option value="">-- Select Item --</option>';
            items.forEach(item => {
                billingItemsMap[item.id] = item;
                select.innerHTML += `<option value="${item.id}" data-price="${item.price}">${item.name} (₹${item.price})</option>`;
            });
        });
    }

    document.getElementById('addItemForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const itemId = document.getElementById('itemSelect').value; const qty = parseInt(document.getElementById('itemQty').value);
        if (!itemId || !qty) return; const item = billingItemsMap[itemId];
        const existing = billItems.find(i => i.item_id == itemId);
        if (existing) { existing.quantity += qty; existing.total = (existing.quantity * parseFloat(item.price)).toFixed(2); }
        else { billItems.push({ item_id: itemId, item_name: item.name, price: item.price, quantity: qty, total: (qty * parseFloat(item.price)).toFixed(2) }); }
        renderBillItems(); document.getElementById('itemSelect').value = ''; document.getElementById('itemQty').value = 1;
    });

    function renderBillItems() {
        const tbody = document.querySelector('#billItemsTable tbody'); tbody.innerHTML = ''; let total = 0;
        billItems.forEach((item, idx) => {
            total += parseFloat(item.total);
            tbody.innerHTML += `<tr><td>${item.item_name}</td><td>₹${item.price}</td><td>${item.quantity}</td><td>₹${item.total}</td><td><button class='btn btn-danger btn-sm' onclick='removeBillItem(${idx})'>X</button></td></tr>`;
        });
        document.getElementById('billTotal').textContent = total.toFixed(2);
    }
    function removeBillItem(idx) { billItems.splice(idx, 1); renderBillItems(); }

    document.getElementById('saveBillBtn').addEventListener('click', function() {
        if (!billItems.length) { Swal.fire('Oops...', 'Please add at least one item before saving!', 'warning'); return; }
        fetch('/add_bill_items', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ uhid: currentUhid, items: billItems }) })
        .then(res => res.json()).then(data => {
            if(data.success) {
                const currentBillEl = document.getElementById('bill-' + currentUhid);
                currentBillEl.textContent = (parseFloat(currentBillEl.textContent) + parseFloat(data.total)).toFixed(2);
                billItems = []; renderBillItems(); loadBillHistory(currentUhid);
                Swal.fire('Saved!', 'Bill items have been added successfully.', 'success');
            } else { Swal.fire('Error!', data.error || 'Could not save bill items.', 'error'); }
        });
    });

    function loadBillHistory(uhid) {
        fetch('/bill_history/' + uhid).then(res => res.json()).then(history => {
            const tbody = document.querySelector('#billHistoryTable tbody'); tbody.innerHTML = '';
            history.forEach(row => { tbody.innerHTML += `<tr><td>${new Date(row.created_at).toLocaleString()}</td><td>${row.item_name}</td><td>₹${row.price}</td><td>${row.quantity}</td><td>₹${row.total}</td></tr>`; });
        });
    }

    document.querySelectorAll('.billing-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            currentUhid = btn.getAttribute('data-uhid'); document.getElementById('billingUhid').value = currentUhid;
            billItems = []; renderBillItems(); loadBillingItems(); loadBillHistory(currentUhid);
        });
    });

    document.querySelectorAll('.clear-bill-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const uhid = btn.getAttribute('data-uhid');
            const payMethod = document.querySelector(`.pay-method-select[data-uhid="${uhid}"]`).value;
            const billAmount = document.getElementById('bill-' + uhid).textContent;
            if (parseFloat(billAmount) === 0) {
                 Swal.fire('Info', 'The bill is already cleared.', 'info');
                 return;
            }

            Swal.fire({
                title: 'Clear Bill?', text: `This will mark the bill of ₹${billAmount} as paid by ${payMethod}. This action cannot be undone.`,
                icon: 'warning', showCancelButton: true, confirmButtonColor: '#28A745', cancelButtonColor: '#DC3545', confirmButtonText: 'Yes, clear it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch('/clear_bill', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ uhid, pay_method: payMethod }) })
                    .then(res => res.json()).then(data => {
                        if (data.success) {
                            document.getElementById('bill-' + uhid).textContent = '0.00';
                            Swal.fire('Cleared!', 'The bill has been successfully cleared.', 'success');
                        } else { Swal.fire('Error!', data.error || 'Could not clear the bill.', 'error'); }
                    });
                }
            });
        });
    });
</script>
</body>
</html>